<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>Carte interactive de Barcelone</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f4f4f4;
        }

        #map {
            height: 100vh;
            z-index: 1;
        }

        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: white;
            padding: 16px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
            width: 220px;
        }

        #controls label {
            font-weight: bold;
            margin-top: 10px;
            display: block;
        }

        #controls select,
        #controls button {
            width: 100%;
            margin-top: 5px;
            padding: 6px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #ccc;
            box-sizing: border-box;
        }

        #controls button {
            background-color: #007bff;
            color: white;
            border: none;
            margin-top: 10px;
            cursor: pointer;
        }

        #controls button:hover {
            background-color: #0056b3;
        }
    </style>
</head>

<body>
    <div id="controls">
        <label for="start">Point de dÃ©part :</label>
        <select id="start"></select>

        <label for="end">Destination :</label>
        <select id="end"></select>

        <button onclick="calculateRoute()">Calculer lâ€™itinÃ©raire</button>
        <button onclick="resetRoute()">RÃ©initialiser</button>
        <button onclick="createTour()">CrÃ©er une tournÃ©e touristique</button>


        <label for="basemap">Fond de carte :</label>
        <select id="basemap" onchange="changeBaseMap(this.value)">
            <option value="light">Carte claire</option>
            <option value="satellite">Satellite</option>
        </select>

        <hr>
        <label><strong>Filtres :</strong></label>
        <div>
            <label><input type="checkbox" class="filter" value="hotel" checked> ðŸŸ¦ HÃ´tel</label><br>
            <label><input type="checkbox" class="filter" value="parc" checked> ðŸŸ© Parcs</label><br>
            <label><input type="checkbox" class="filter" value="restaurant" checked> ðŸŸ¥ Restaurants</label><br>
            <label><input type="checkbox" class="filter" value="monument" checked> ðŸŸª Monuments</label><br>
            <label><input type="checkbox" class="filter" value="bar" checked> ðŸŸ§ Bars</label><br>
            <label><input type="checkbox" class="filter" value="plage" checked> ðŸŸ¨ Plages</label>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.min.js"></script>
    <script>
        const map = L.map('map').setView([41.3851, 2.1734], 13);

        const tileLayers = {
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap & Carto',
                subdomains: 'abcd',
                maxZoom: 19
            }),
            satellite: L.tileLayer('https://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                maxZoom: 20,
                subdomains: ['mt0', 'mt1', 'mt2', 'mt3'],
                attribution: 'DonnÃ©es Â© Google Maps'
            })
        };

        tileLayers.light.addTo(map);

        function changeBaseMap(style) {
            Object.values(tileLayers).forEach(layer => map.removeLayer(layer));
            tileLayers[style].addTo(map);
        }

        let routingControl = null;
        const startSelect = document.getElementById('start');
        const endSelect = document.getElementById('end');
        const points = {};
        const markersByCategory = {};

        function getIcon(category) {
            const colors = {
                parc: "green",
                restaurant: "red",
                monument: "violet",
                bar: "orange",
                plage: "yellow",
                hotel: "blue"
            };
            const color = colors[category] || "gray";

            return L.icon({
                iconUrl: `https://cdn.jsdelivr.net/gh/pointhi/leaflet-color-markers@master/img/marker-icon-${color}.png`,
                shadowUrl: "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
                iconSize: [25, 41],
                iconAnchor: [12, 41],
                popupAnchor: [1, -34],
                shadowSize: [41, 41]
            });
        }


        fetch('barcelone.geojson')
            .then(response => response.json())
            .then(data => {
                data.features.forEach(feature => {
                    const name = feature.properties.name;
                    const desc = feature.properties.description;
                    const cat = feature.properties.category || "autre";
                    const coords = [feature.geometry.coordinates[1], feature.geometry.coordinates[0]];

                    points[name] = coords;
                    startSelect.appendChild(new Option(name, name));
                    endSelect.appendChild(new Option(name, name));

                    const marker = L.marker(coords, { icon: getIcon(cat) });
                    marker.bindPopup(`<strong>${name}</strong><br>${desc}`);
                    marker.addTo(map);

                    if (!markersByCategory[cat]) markersByCategory[cat] = [];
                    markersByCategory[cat].push(marker);
                });
            });

        function calculateRoute() {
            const start = startSelect.value;
            const end = endSelect.value;

            if (!start || !end || start === end) {
                alert("Veuillez choisir deux lieux diffÃ©rents.");
                return;
            }

            if (routingControl) {
                map.removeControl(routingControl);
            }

            routingControl = L.Routing.control({
                waypoints: [L.latLng(points[start]), L.latLng(points[end])],
                routeWhileDragging: false,
                language: 'fr',
                createMarker: () => null
            }).addTo(map);
        }

        function resetRoute() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }
            startSelect.selectedIndex = 0;
            endSelect.selectedIndex = 0;
        }

        // Filtrage des marqueurs par catÃ©gorie
        document.querySelectorAll('.filter').forEach(checkbox => {
            checkbox.addEventListener('change', () => {
                const cat = checkbox.value;
                const isChecked = checkbox.checked;
                if (markersByCategory[cat]) {
                    markersByCategory[cat].forEach(marker => {
                        if (isChecked) {
                            marker.addTo(map);
                        } else {
                            map.removeLayer(marker);
                        }
                    });
                }
            });
        });

        function createTour() {
            if (routingControl) {
                map.removeControl(routingControl);
                routingControl = null;
            }

            // Lieux de la tournÃ©e (doivent correspondre EXACTEMENT aux noms du GeoJSON)
            const tourStops = [
                "Parc GÃ¼ell",
                "Sagrada FamÃ­lia",
                "Tapas Season",
                "Hotel SYSTELCOMS"
            ];

            // VÃ©rifie que tous les points existent
            const missing = tourStops.filter(name => !points[name]);
            if (missing.length > 0) {
                alert("Certains lieux de la tournÃ©e sont introuvables : " + missing.join(", "));
                return;
            }

            // CrÃ©er les waypoints pour le routing
            const waypoints = tourStops.map(name => L.latLng(points[name]));

            routingControl = L.Routing.control({
                waypoints: waypoints,
                routeWhileDragging: false,
                language: 'fr',
                createMarker: (i, wp, n) => {
                    return L.marker(wp, {
                        icon: L.divIcon({
                            className: 'tour-marker',
                            html: `<div style="background:#007bff;color:white;border-radius:50%;padding:4px;width:24px;height:24px;text-align:center;">${i + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    });
                }
            }).addTo(map);
        }

    </script>
</body>

</html>